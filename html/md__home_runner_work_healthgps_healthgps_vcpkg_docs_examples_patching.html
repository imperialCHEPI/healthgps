<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Health-GPS: Patching Example: Patching libpng to work for x64-uwp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Health-GPS
   &#160;<span id="projectnumber">1.2.2.0</span>
   </div>
   <div id="projectbrief">Global Health Policy Simulation model (Health-GPS)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_runner_work_healthgps_healthgps_vcpkg_docs_examples_patching.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Patching Example: Patching libpng to work for x64-uwp </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md2793"></a>
Initial error logs</h2>
<p>First, try building:</p>
<div class="fragment"><div class="line">PS D:\src\vcpkg&gt; vcpkg install libpng:x64-uwp --editable</div>
<div class="line">Computing installation plan...</div>
<div class="line">The following packages will be built and installed:</div>
<div class="line">    libpng[core]:x64-uwp</div>
<div class="line">Starting package 1/1: libpng:x64-uwp</div>
<div class="line">Building package libpng[core]:x64-uwp...</div>
<div class="line">-- Using cached D:/src/vcpkg/downloads/glennrp-libpng-v1.6.37.tar.gz</div>
<div class="line">-- Extracting source D:/src/vcpkg/downloads/glennrp-libpng-v1.6.37.tar.gz</div>
<div class="line">-- Using source at D:/src/vcpkg/buildtrees/libpng/src/v1.6.37-c993153cdf</div>
<div class="line">-- Configuring x64-uwp</div>
<div class="line">-- Building x64-uwp-rel</div>
<div class="line">CMake Error at scripts/cmake/execute_required_process.cmake:14 (message):</div>
<div class="line">  Command failed: C:/Program Files/CMake/bin/cmake.exe;--build;.;--config;Release</div>
<div class="line"> </div>
<div class="line">  Working Directory: D:/src/vcpkg/buildtrees/libpng/x64-uwp-rel</div>
<div class="line"> </div>
<div class="line">  See logs for more information:</div>
<div class="line"> </div>
<div class="line">      D:\src\vcpkg\buildtrees\libpng\build-x64-uwp-rel-out.log</div>
<div class="line">      D:\src\vcpkg\buildtrees\libpng\build-x64-uwp-rel-err.log</div>
<div class="line"> </div>
<div class="line">Call Stack (most recent call first):</div>
<div class="line">  scripts/cmake/vcpkg_build_cmake.cmake:3 (execute_required_process)</div>
<div class="line">  ports/libpng/portfile.cmake:22 (vcpkg_build_cmake)</div>
<div class="line">  scripts/ports.cmake:84 (include)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Error: build command failed</div>
</div><!-- fragment --><p>Next, looking at the above logs (build-xxx-out.log and build-xxx-err.log).</p>
<div class="fragment"><div class="line">// build-x64-uwp-rel-out.log</div>
<div class="line">...</div>
<div class="line">&quot;D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\ALL_BUILD.vcxproj&quot; (default target) (1) -&gt;</div>
<div class="line">&quot;D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\png.vcxproj&quot; (default target) (3) -&gt;</div>
<div class="line">(ClCompile target) -&gt; </div>
<div class="line">  D:\src\vcpkg\buildtrees\libpng\src\v1.6.37-c993153cdf\pngerror.c(775): warning C4013: &#39;ExitProcess&#39; undefined; assuming extern returning int [D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\png.vcxproj]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">&quot;D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\ALL_BUILD.vcxproj&quot; (default target) (1) -&gt;</div>
<div class="line">&quot;D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\png.vcxproj&quot; (default target) (3) -&gt;</div>
<div class="line">(Link target) -&gt; </div>
<div class="line">  pngerror.obj : error LNK2019: unresolved external symbol _ExitProcess referenced in function _png_longjmp [D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\png.vcxproj]</div>
<div class="line">  D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\Release\libpng16.dll : fatal error LNK1120: 1 unresolved externals [D:\src\vcpkg\buildtrees\libpng\x64-uwp-rel\png.vcxproj]</div>
<div class="line"> </div>
<div class="line">    1 Warning(s)</div>
<div class="line">    2 Error(s)</div>
<div class="line"> </div>
<div class="line">Time Elapsed 00:00:04.19</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2794"></a>
Identify the problematic code</h2>
<p>Taking a look at <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682658(v=vs.85).aspx">MSDN</a> shows that <code>ExitProcess</code> is only available for desktop apps. Additionally, it's useful to see the surrounding context:</p>
<div class="fragment"><div class="line"><span class="comment">/* buildtrees\libpng\src\v1.6.37-c993153cdf\pngerror.c:769 */</span></div>
<div class="line">    <span class="comment">/* If control reaches this point, png_longjmp() must not return. The only</span></div>
<div class="line"><span class="comment">    * choice is to terminate the whole process (or maybe the thread); to do</span></div>
<div class="line"><span class="comment">    * this the ANSI-C abort() function is used unless a different method is</span></div>
<div class="line"><span class="comment">    * implemented by overriding the default configuration setting for</span></div>
<div class="line"><span class="comment">    * PNG_ABORT().</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    PNG_ABORT();</div>
</div><!-- fragment --><p>A recursive search for <code>PNG_ABORT</code> reveals the definition: </p><div class="fragment"><div class="line">PS D:\src\vcpkg\buildtrees\libpng\src\v1.6.37-c993153cdf&gt; findstr /snipl &quot;PNG_ABORT&quot; *</div>
<div class="line">CHANGES:701:  Added PNG_SETJMP_SUPPORTED, PNG_SETJMP_NOT_SUPPORTED, and PNG_ABORT() macros</div>
<div class="line">libpng-manual.txt:432:errors will result in a call to PNG_ABORT() which defaults to abort().</div>
<div class="line">libpng-manual.txt:434:You can #define PNG_ABORT() to a function that does something</div>
<div class="line">libpng-manual.txt:2753:errors will result in a call to PNG_ABORT() which defaults to abort().</div>
<div class="line">libpng-manual.txt:2755:You can #define PNG_ABORT() to a function that does something</div>
<div class="line">libpng-manual.txt:4226:PNG_NO_SETJMP, in which case it is handled via PNG_ABORT()),</div>
<div class="line">libpng.3:942:errors will result in a call to PNG_ABORT() which defaults to abort().</div>
<div class="line">libpng.3:944:You can #define PNG_ABORT() to a function that does something</div>
<div class="line">libpng.3:3263:errors will result in a call to PNG_ABORT() which defaults to abort().</div>
<div class="line">libpng.3:3265:You can #define PNG_ABORT() to a function that does something</div>
<div class="line">libpng.3:4736:PNG_NO_SETJMP, in which case it is handled via PNG_ABORT()),</div>
<div class="line">png.h:994: * will use it; otherwise it will call PNG_ABORT().  This function was</div>
<div class="line">pngerror.c:773:    * PNG_ABORT().</div>
<div class="line">pngerror.c:775:   PNG_ABORT();</div>
<div class="line">pngpriv.h:459:#ifndef PNG_ABORT</div>
<div class="line">pngpriv.h:461:#    define PNG_ABORT() ExitProcess(0)</div>
<div class="line">pngpriv.h:463:#    define PNG_ABORT() abort()</div>
</div><!-- fragment --><p>This already gives us some great clues, but the full definition tells the complete story.</p>
<div class="fragment"><div class="line"><span class="comment">/* buildtrees\libpng\src\v1.6.37-c993153cdf\pngpriv.h:459 */</span></div>
<div class="line"><span class="preprocessor">#ifndef PNG_ABORT</span></div>
<div class="line"><span class="preprocessor">#  ifdef _WINDOWS_</span></div>
<div class="line"><span class="preprocessor">#    define PNG_ABORT() ExitProcess(0)</span></div>
<div class="line"><span class="preprocessor">#  else</span></div>
<div class="line"><span class="preprocessor">#    define PNG_ABORT() abort()</span></div>
<div class="line"><span class="preprocessor">#  endif</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p><code>abort()</code> is a standard CRT call and certainly available in UWP, so we just need to convince libpng to be more platform agnostic. The easiest and most reliable way to achieve this is to patch the code; while in this particular case we could pass in a compiler flag to override <code>PNG_ABORT</code> because this is a private header, in general it is more reliable to avoid adding more required compiler switches when possible (especially when it isn't already exposed as a CMake option).</p>
<h2><a class="anchor" id="autotoc_md2795"></a>
Patching the code to improve compatibility</h2>
<p>We recommend using git to create the patch file, since you'll already have it installed. </p><div class="fragment"><div class="line">PS D:\src\vcpkg\buildtrees\libpng\src\v1.6.37-c993153cdf&gt; git init .</div>
<div class="line">Initialized empty Git repository in D:/src/vcpkg/buildtrees/libpng/src/v1.6.37-c993153cdf/.git/</div>
<div class="line"> </div>
<div class="line">PS D:\src\vcpkg\buildtrees\libpng\src\v1.6.37-c993153cdf&gt; git add .</div>
<div class="line">warning: LF will be replaced by CRLF in ANNOUNCE.</div>
<div class="line">The file will have its original line endings in your working directory.</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">PS D:\src\vcpkg\buildtrees\libpng\src\v1.6.37-c993153cdf&gt; git commit -m &quot;temp&quot;</div>
<div class="line">[master (root-commit) 68f253f] temp</div>
<div class="line"> 422 files changed, 167717 insertions(+)</div>
<div class="line">...</div>
</div><!-- fragment --><p>Now we can modify <code>pngpriv.h</code> to use <code>abort()</code> everywhere. </p><div class="fragment"><div class="line"><span class="comment">/* buildtrees\libpng\src\v1.6.37-c993153cdf\pngpriv.h:459 */</span></div>
<div class="line"><span class="preprocessor">#ifndef PNG_ABORT</span></div>
<div class="line"><span class="preprocessor">#  define PNG_ABORT() abort()</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p>The output of <code>git diff</code> is already in patch format, so we just need to save the patch into the <code>ports/libpng</code> directory. </p><div class="fragment"><div class="line">PS buildtrees\libpng\src\v1.6.37-c993153cdf&gt; git diff --ignore-space-at-eol | out-file -enc ascii ..\..\..\..\ports\libpng\use-abort-on-all-platforms.patch</div>
</div><!-- fragment --><p>Finally, we need to apply the patch after extracting the source. </p><div class="fragment"><div class="line"># ports\libpng\portfile.cmake</div>
<div class="line">...</div>
<div class="line">vcpkg_extract_source_archive_ex(</div>
<div class="line">  OUT_SOURCE_PATH SOURCE_PATH</div>
<div class="line">  ARCHIVE ${ARCHIVE}</div>
<div class="line">  PATCHES </div>
<div class="line">    &quot;use-abort-on-all-platforms.patch&quot;</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">vcpkg_cmake_configure(</div>
<div class="line">...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2796"></a>
Verification</h2>
<p>To be completely sure this works from scratch, we need to remove the package and rebuild it:</p>
<div class="fragment"><div class="line">PS D:\src\vcpkg&gt; vcpkg remove libpng:x64-uwp</div>
<div class="line">Package libpng:x64-uwp was successfully removed</div>
</div><!-- fragment --><p>Now we try a fresh, from scratch install.</p>
<div class="fragment"><div class="line">PS D:\src\vcpkg&gt; vcpkg install libpng:x64-uwp</div>
<div class="line">Computing installation plan...</div>
<div class="line">The following packages will be built and installed:</div>
<div class="line">    libpng[core]:x64-uwp</div>
<div class="line">Starting package 1/1: libpng:x64-uwp</div>
<div class="line">Building package libpng[core]:x64-uwp...</div>
<div class="line">Could not locate cached archive: C:\Users\me\AppData\Local\vcpkg/archives\f4\f44b54f818f78b9a4ccd34b3666f566f94286850.zip</div>
<div class="line">-- Using cached D:/src/vcpkg/downloads/glennrp-libpng-v1.6.37.tar.gz</div>
<div class="line">-- Extracting source D:/src/vcpkg/downloads/glennrp-libpng-v1.6.37.tar.gz</div>
<div class="line">-- Applying patch use_abort.patch</div>
<div class="line">-- Applying patch cmake.patch</div>
<div class="line">-- Applying patch pkgconfig.patch</div>
<div class="line">-- Applying patch pkgconfig.2.patch</div>
<div class="line">-- Using source at D:/src/vcpkg/buildtrees/libpng/src/v1.6.37-10db9f58e4.clean</div>
<div class="line">-- Configuring x64-uwp</div>
<div class="line">-- Building x64-uwp-dbg</div>
<div class="line">-- Building x64-uwp-rel</div>
<div class="line">-- Fixing pkgconfig file: D:/src/vcpkg/packages/libpng_x64-uwp/lib/pkgconfig/libpng.pc</div>
<div class="line">-- Fixing pkgconfig file: D:/src/vcpkg/packages/libpng_x64-uwp/lib/pkgconfig/libpng16.pc</div>
<div class="line">-- Fixing pkgconfig file: D:/src/vcpkg/packages/libpng_x64-uwp/debug/lib/pkgconfig/libpng.pc</div>
<div class="line">-- Fixing pkgconfig file: D:/src/vcpkg/packages/libpng_x64-uwp/debug/lib/pkgconfig/libpng16.pc</div>
<div class="line">-- Installing: D:/src/vcpkg/packages/libpng_x64-uwp/share/libpng/copyright</div>
<div class="line">-- Performing post-build validation</div>
<div class="line">-- Performing post-build validation done</div>
<div class="line">Stored binary cache: C:\Users\me\AppData\Local\vcpkg/archives\f4\f44b54f818f78b9a4ccd34b3666f566f94286850.zip</div>
<div class="line">Building package libpng[core]:x64-uwp... done</div>
<div class="line">Installing package libpng[core]:x64-uwp...</div>
<div class="line">Installing package libpng[core]:x64-uwp... done</div>
<div class="line">Elapsed time for package libpng:x64-uwp: 11.94 s</div>
<div class="line"> </div>
<div class="line">Total elapsed time: 11.95 s</div>
<div class="line"> </div>
<div class="line">The package libpng:x64-uwp provides CMake targets:</div>
<div class="line"> </div>
<div class="line">    find_package(libpng CONFIG REQUIRED)</div>
<div class="line">    target_link_libraries(main PRIVATE png)</div>
</div><!-- fragment --><p>Finally, to fully commit and publish the changes, we need to bump the port version in <code>vcpkg.json</code>, and add the patch file to source control, then make a Pull Request!</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;name&quot;: &quot;libpng&quot;,</div>
<div class="line">  &quot;version&quot;: &quot;1.6.37&quot;,</div>
<div class="line">  &quot;port-version&quot;: 1,</div>
<div class="line">  &quot;dependencies&quot;: [</div>
<div class="line">    &quot;zlib&quot;</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
