<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Health-GPS: &lt;tt&gt;vcpkg-eg-mac&lt;/tt&gt; VMs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Health-GPS
   &#160;<span id="projectnumber">1.2.2.0</span>
   </div>
   <div id="projectbrief">Global Health Policy Simulation model (Health-GPS)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_runner_work_healthgps_healthgps_vcpkg_scripts_azure_pipelines_osx_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><code>vcpkg-eg-mac</code> VMs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md4071"></a>
Table of Contents</h1>
<ul>
<li><a href="#vcpkg-eg-mac-vms"><code>vcpkg-eg-mac</code> VMs</a><ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#basic-usage">Basic Usage</a><ul>
<li><a href="#creating-a-new-vagrant-box">Creating a new Vagrant box</a><ul>
<li><a href="#vm-software-versions">VM Software Versions</a></li>
</ul>
</li>
<li><a href="#creating-a-new-azure-agent-pool">Creating a New Azure Agent Pool</a></li>
<li><a href="#running-the-vm">Running the VM</a></li>
</ul>
</li>
<li><a href="#getting-an-azure-pipelines-pat">Getting an Azure Pipelines PAT</a></li>
<li><a href="#setting-up-a-new-macos-machine">Setting up a new macOS machine</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#internal-accessing-the-macos-fileshare">(Internal) Accessing the macOS fileshare</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md4072"></a>
Basic Usage</h1>
<p>The most common operation here is to set up a new VM for Azure pipelines; we try to make that operation as easy as possible. It should take all of three steps, assuming the machine is already set up (or read <a href="#setting-up-a-new-macos-machine">these instructions</a> for how to set up a machine):</p>
<ol type="1">
<li><a href="#creating-a-new-vagrant-box">Create a new vagrant box</a></li>
<li><a href="#creating-a-new-azure-agent-pool">Create a new agent pool</a></li>
<li><a href="#running-the-vm">Setup and run the vagrant VM</a></li>
<li>Update <code>azure-pipelines.yml</code> and <code>azure-pipelines-osx.yml</code> to point to the new macOS pool.</li>
</ol>
<h2><a class="anchor" id="autotoc_md4073"></a>
Creating a new Vagrant box</h2>
<p>Whenever we want to install updated versions of the command line tools, or of macOS, we need to create a new vagrant box. This is pretty easy, but the results of the creation are not public, since we're concerned about licensing. However, if you're sure you're following Apple's licensing, you can set up your own vagrant boxes that are the same as ours by doing the following:</p>
<p>You'll need some prerequisites:</p>
<ul>
<li>An Xcode installer - you can get this from Apple's developer website, although you'll need to sign in first: <a href="https://developer.apple.com/downloads">https://developer.apple.com/downloads</a></li>
<li>The software installed by <code>Install-Prerequisites.ps1</code></li>
</ul>
<p>If you're updating the CI pool, make sure you update macOS.</p>
<p>First, you'll need to create a base VM; this is where you determine what version of macOS is installed. Follow the Parallels process for creating a macOS VM; this involves updating to whatever version, and then scrolling right until you find "Install macOS from recovery partition".</p>
<p>Once you've done this, you can run through the installation of macOS onto a new VM. You should set the username to <code>vagrant</code>.</p>
<p>Once it's finished installing, make sure to turn on the SSH server. Open System Preferences, then go to Sharing &gt; Remote Login, and turn it on. You'll then want to add the vagrant SSH keys to the VM's vagrant user. Open the terminal application and run the following:</p>
<div class="fragment"><div class="line">$ # basic stuff</div>
<div class="line">$ date | sudo tee &#39;/etc/vagrant_box_build_time&#39;</div>
<div class="line">$ printf &#39;vagrant\tALL=(ALL)\tNOPASSWD:\tALL\n&#39; | sudo tee -a &#39;/etc/sudoers.d/vagrant&#39;</div>
<div class="line">$ sudo chmod 0440 &#39;/etc/sudoers.d/vagrant&#39;</div>
<div class="line">$ # then install vagrant keys</div>
<div class="line">$ mkdir -p ~/.ssh</div>
<div class="line">$ curl -fsSL &#39;https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub&#39; &gt;~/.ssh/authorized_keys</div>
<div class="line">$ chmod 0600 ~/.ssh/authorized_keys</div>
</div><!-- fragment --><p>Finally, you'll need to install the Parallel Tools. From your host, in the top bar, go to Actions &gt; Install Parallels Tools..., and then follow the instructions.</p>
<p>Now, let's package the VM into a base box. (The following instructions are adapted from <a href="https://parallels.github.io/vagrant-parallels/docs/boxes/base.html">these official instructions</a>).</p>
<p>Run the following commands:</p>
<div class="fragment"><div class="line">$ cd ~/Parallels</div>
<div class="line">$ echo &#39;{ &quot;provider&quot;: &quot;parallels&quot; }&#39; &gt;metadata.json</div>
<div class="line">$ tar zcvf &lt;macos version&gt;.box ./metadata.json ./&lt;name of VM&gt;.pvm</div>
</div><!-- fragment --><p>This will create a box file which contains all the necessary data. You can delete the <code>metadata.json</code> file after.</p>
<p>Once you've done that, you can upload it to the fileshare, under <code>share/boxes/macos-base</code>, add it to <code>share/boxes/macos-base.json</code>, and finally add it to vagrant:</p>
<div class="fragment"><div class="line">$ vagrant box add ~/vagrant/share/boxes/macos-base.json</div>
</div><!-- fragment --><p>Then, we'll create the final box, which contains all the necessary programs for doing CI work. Copy <code>configuration/Vagrantfile-box.rb</code> as <code>Vagrantfile</code>, and <code>configuration/vagrant-box-configuration.json</code> into a new directory; into that same directory, download the Xcode command line tools dmg, and name it <code>clt.dmg</code>. Then, run the following in that directory:</p>
<div class="fragment"><div class="line">$ vagrant up</div>
<div class="line">$ vagrant package</div>
</div><!-- fragment --><p>This will create a <code>package.box</code>, which is the box file for the base VM. Once you've created this box, if you're making it the new box for the CI, upload it to the fileshare, under <code>share/boxes/macos-ci</code>. Then, add the metadata about the box (the name and version) to <code>share/boxes/macos-ci.json</code>. Once you've done that, add the software versions under <a href="#vm-software-versions">VM Software Versions</a>.</p>
<h3><a class="anchor" id="autotoc_md4074"></a>
VM Software Versions</h3>
<ul>
<li>2022-02-04 (minor update to 2022-01-03)<ul>
<li>macOS: 12.1</li>
<li>Xcode CLTs: 13.2</li>
</ul>
</li>
<li>2022-01-03:<ul>
<li>macOS: 12.1</li>
<li>Xcode CLTs: 13.2</li>
</ul>
</li>
<li>2021-07-27:<ul>
<li>macOS: 11.5.1</li>
<li>Xcode CLTs: 12.5.1</li>
</ul>
</li>
<li>2021-04-16:<ul>
<li>macOS: 11.2.3</li>
<li>Xcode CLTs: 12.4</li>
</ul>
</li>
<li>2020-09-28:<ul>
<li>macOS: 10.15.6</li>
<li>Xcode CLTs: 12</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md4075"></a>
Creating a New Azure Agent Pool</h2>
<p>When updating the macOS machines to a new version, you'll need to create a new agent pool for the machines to join. The standard for this is to name it <code>PrOsx-YYYY-MM-DD</code>, with <code>YYYY-MM-DD</code> the day that the process is started.</p>
<p>In order to create a new agent pool, go to the <code>vcpkg/public</code> project; go to <code>Project settings</code>, then go to <code>Agent pools</code> under <code>Pipelines</code>. Add a new self-hosted pool, name it as above, and make certain to check the box for "Grant access permission to all pipelines".</p>
<p>Once you've done this, you are done; you can start adding new machines to the pool!</p>
<h2><a class="anchor" id="autotoc_md4076"></a>
Running the VM</h2>
<p>First, make sure that your software is up to date: </p><div class="fragment"><div class="line">$ cd ~/vcpkg</div>
<div class="line">$ git fetch</div>
<div class="line">$ git switch -d origin/master</div>
<div class="line">$ ./scripts/azure-pipelines/osx/Install-Prerequisites.ps1</div>
</div><!-- fragment --><p>as well as checking to make sure macOS is up to date.</p>
<p>Then, follow the instructions for <a href="#internal-accessing-the-macos-fileshare">accessing ~/vagrant/share</a>.</p>
<p>And finally, <a href="#getting-an-azure-pipelines-pat">grab a PAT</a>, update the vagrant box, set up the VM, and run it: </p><div class="fragment"><div class="line">$ vagrant box remove -f vcpkg/macos-ci # This won&#39;t do anything if the machine never had a box before</div>
<div class="line">$ vagrant box add ~/vagrant/share/boxes/macos-ci.json</div>
<div class="line">$ ~/vcpkg/scripts/azure-pipelines/osx/Setup-VagrantMachines.ps1 -Date &lt;box version YYYY-MM-DD&gt; -DevopsPat &lt;PAT&gt;</div>
<div class="line">$ cd ~/vagrant/vcpkg-eg-mac</div>
<div class="line">$ vagrant up # if this fails, reboot through the kvm and/or log in interactively, then come back here</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4077"></a>
Getting an Azure Pipelines PAT</h1>
<p>Personal Access Tokens are an important part of this process, and they are fairly easy to generate. On ADO, under the correct project (in vcpkg's case, "vcpkg"), click on the "User Settings" icon, then go to "Personal access tokens". It is the icon to the left of your user icon, in the top right corner.</p>
<p>Then, create a new token, give it a name, make sure it expires quickly, and give it a custom defined scope that includes the "Agent pools: Read &amp; manage" permission (you'll need to "Show all scopes" to access this). You can now copy this token and use it to allow machines to join.</p>
<h1><a class="anchor" id="autotoc_md4078"></a>
Setting up a new macOS machine</h1>
<p>Before anything else, one must download <code>brew</code> and <code>powershell</code>.</p>
<div class="fragment"><div class="line">$ /bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)&quot;</div>
<div class="line">$ brew cask install powershell</div>
</div><!-- fragment --><p>Then, we need to download the <code>vcpkg</code> repository:</p>
<div class="fragment"><div class="line">$ git clone https://github.com/microsoft/vcpkg</div>
</div><!-- fragment --><p>Then, we need to mint an SSH key:</p>
<div class="fragment"><div class="line">$ ssh-keygen</div>
<div class="line">$ cat .ssh/id_rsa.pub</div>
</div><!-- fragment --><p>Add that SSH key to <code>authorized_keys</code> on the file share machine with the base box.</p>
<p>Next, install prerequisites: </p><div class="fragment"><div class="line">$ cd vcpkg/scripts/azure-pipelines/osx</div>
<div class="line">$ ./Install-Prerequisites.ps1 -Force</div>
</div><!-- fragment --><p>And finally, make sure you can <a href="#internal-accessing-the-macos-fileshare">access ~/vagrant/share</a>.</p>
<h1><a class="anchor" id="autotoc_md4079"></a>
Troubleshooting</h1>
<p>The following are issues that we've run into:</p>
<ul>
<li>(with a Parallels box) <code>vagrant up</code> doesn't work, and vagrant gives the error that the VM is &lsquo;'stopped&rsquo;<code>.<ul>
<li>Try logging into the GUI with the KVM, and retryingvagrant up<code>.</code></li>
</ul>
</code></li>
<li><code><code>(when running a powershell script) The error</code>Failed to initialize CoreCLR, HRESULT: 0x8007001F` is printed.<ul>
<li>Reboot the machine; run <div class="fragment"><div class="line">$ sudo shutdown -r now</div>
</div><!-- fragment --> and wait for the machine to start back up. Then, start again from where the error was emitted.</li>
</ul>
</code></li>
</ul>
<p><code></code></p>
<h1><a class="anchor" id="autotoc_md4080"></a>
(Internal) Accessing the macOS fileshare</h1>
<p><code> The fileshare is located on <code>vcpkgmm-01</code>, under the <code>fileshare</code> user, in the <code>share</code> directory. In order to get <code>sshfs</code> working on the physical machine, You can run <code>Install-Prerequisites.ps1</code> to grab the right software, then either:</code></p>
<p><code></p><div class="fragment"><div class="line">$ mkdir -p ~/vagrant/share</div>
<div class="line">$ sshfs fileshare@vcpkgmm-01:share ~/vagrant/share</div>
</div><!-- fragment --><p></code></p>
<p><code>If you get an error, that means that gatekeeper has prevented the kernel extension from loading, so you'll need to access the GUI of the machine, go to System Preferences, Security &amp; Privacy, General, unlock the settings, and allow system extensions from the osxfuse developer to run. Then, you'll be able to add ~/vagrant/share as an sshfs. </code></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
