<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Health-GPS: Assembly Tests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Health-GPS
   &#160;<span id="projectnumber">1.2.2.0</span>
   </div>
   <div id="projectbrief">Global Health Policy Simulation model (Health-GPS)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_runner_work_healthgps_healthgps_vcpkg_buildtrees_benchmark_src_v1_7_1_1d39cd1386_clean_docs_AssemblyTests.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Assembly Tests </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Benchmark library provides a number of functions whose primary purpose in to affect assembly generation, including <code>DoNotOptimize</code> and <code>ClobberMemory</code>. In addition there are other functions, such as <code>KeepRunning</code>, for which generating good assembly is paramount.</p>
<p>For these functions it's important to have tests that verify the correctness and quality of the implementation. This requires testing the code generated by the compiler.</p>
<p>This document describes how the Benchmark library tests compiler output, as well as how to properly write new tests.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Anatomy of a Test</h1>
<p>Writing a test has two steps:</p>
<ul>
<li>Write the code you want to generate assembly for.</li>
<li>Add <code>// CHECK</code> lines to match against the verified assembly.</li>
</ul>
<p>Example: </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line"> </div>
<div class="line">// CHECK-LABEL: test_add:</div>
<div class="line">extern &quot;C&quot; int test_add() {</div>
<div class="line">    extern int ExternInt;</div>
<div class="line">    return ExternInt + 1;</div>
<div class="line"> </div>
<div class="line">    // CHECK: movl ExternInt(%rip), %eax</div>
<div class="line">    // CHECK: addl %eax</div>
<div class="line">    // CHECK: ret</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md17"></a>
LLVM Filecheck</h3>
<p><a href="https://llvm.org/docs/CommandGuide/FileCheck.html">LLVM's Filecheck</a> is used to test the generated assembly against the <code>// CHECK</code> lines specified in the tests source file. Please see the documentation linked above for information on how to write <code>CHECK</code> directives.</p>
<h3><a class="anchor" id="autotoc_md18"></a>
Tips and Tricks:</h3>
<ul>
<li>Tests should match the minimal amount of output required to establish correctness. <code>CHECK</code> directives don't have to match on the exact next line after the previous match, so tests should omit checks for unimportant bits of assembly. (<a href="https://llvm.org/docs/CommandGuide/FileCheck.html#the-check-next-directive"><code>CHECK-NEXT</code></a> can be used to ensure a match occurs exactly after the previous match).</li>
<li>The tests are compiled with <code>-O3 -g0</code>. So we're only testing the optimized output.</li>
<li>The assembly output is further cleaned up using <code><a class="el" href="strip__asm_8py.html">tools/strip_asm.py</a></code>. This removes comments, assembler directives, and unused labels before the test is run.</li>
<li>The generated and stripped assembly file for a test is output under <code>&lt;build-directory&gt;/test/&lt;test-name&gt;.s</code></li>
<li>Filecheck supports using <a href="https://llvm.org/docs/CommandGuide/FileCheck.html#cmdoption-check-prefixes"><code>CHECK</code> prefixes</a> to specify lines that should only match in certain situations. The Benchmark tests use <code>CHECK-CLANG</code> and <code>CHECK-GNU</code> for lines that are only expected to match Clang or GCC's output respectively. Normal <code>CHECK</code> lines match against all compilers. (Note: <code>CHECK-NOT</code> and <code>CHECK-LABEL</code> are NOT prefixes. They are versions of non-prefixed <code>CHECK</code> lines)</li>
<li>Use <code>extern "C"</code> to disable name mangling for specific functions. This makes them easier to name in the <code>CHECK</code> lines.</li>
</ul>
<h1><a class="anchor" id="autotoc_md19"></a>
Problems Writing Portable Tests</h1>
<p>Writing tests which check the code generated by a compiler are inherently non-portable. Different compilers and even different compiler versions may generate entirely different code. The Benchmark tests must tolerate this.</p>
<p>LLVM Filecheck provides a number of mechanisms to help write "more portable" tests; including <a href="https://llvm.org/docs/CommandGuide/FileCheck.html#filecheck-pattern-matching-syntax">matching using regular expressions</a>, allowing the creation of <a href="https://llvm.org/docs/CommandGuide/FileCheck.html#filecheck-variables">named variables</a> for later matching, and <a href="https://llvm.org/docs/CommandGuide/FileCheck.html#the-check-dag-directive">checking non-sequential matches</a>.</p>
<h3><a class="anchor" id="autotoc_md20"></a>
Capturing Variables</h3>
<p>For example, say GCC stores a variable in a register but Clang stores it in memory. To write a test that tolerates both cases we "capture" the destination of the store, and then use the captured expression to write the remainder of the test.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">// CHECK-LABEL: test_div_no_op_into_shr:</div>
<div class="line">extern &quot;C&quot; void test_div_no_op_into_shr(int value) {</div>
<div class="line">    int divisor = 2;</div>
<div class="line">    benchmark::DoNotOptimize(divisor); // hide the value from the optimizer</div>
<div class="line">    return value / divisor;</div>
<div class="line"> </div>
<div class="line">    // CHECK: movl $2, [[DEST:.*]]</div>
<div class="line">    // CHECK: idivl [[DEST]]</div>
<div class="line">    // CHECK: ret</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md21"></a>
Using Regular Expressions to Match Differing Output</h3>
<p>Often tests require testing assembly lines which may subtly differ between compilers or compiler versions. A common example of this is matching stack frame addresses. In this case regular expressions can be used to match the differing bits of output. For example:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">int ExternInt;</div>
<div class="line">struct Point { int x, y, z; };</div>
<div class="line"> </div>
<div class="line">// CHECK-LABEL: test_store_point:</div>
<div class="line">extern &quot;C&quot; void test_store_point() {</div>
<div class="line">    Point p{ExternInt, ExternInt, ExternInt};</div>
<div class="line">    benchmark::DoNotOptimize(p);</div>
<div class="line"> </div>
<div class="line">    // CHECK: movl ExternInt(%rip), %eax</div>
<div class="line">    // CHECK: movl %eax, -{{[0-9]+}}(%rsp)</div>
<div class="line">    // CHECK: movl %eax, -{{[0-9]+}}(%rsp)</div>
<div class="line">    // CHECK: movl %eax, -{{[0-9]+}}(%rsp)</div>
<div class="line">    // CHECK: ret</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md22"></a>
Current Requirements and Limitations</h1>
<p>The tests require Filecheck to be installed along the <code>PATH</code> of the build machine. Otherwise the tests will be disabled.</p>
<p>Additionally, as mentioned in the previous section, codegen tests are inherently non-portable. Currently the tests are limited to:</p>
<ul>
<li>x86_64 targets.</li>
<li>Compiled with GCC or Clang</li>
</ul>
<p>Further work could be done, at least on a limited basis, to extend the tests to other architectures and compilers (using <code>CHECK</code> prefixes).</p>
<p>Furthermore, the tests fail for builds which specify additional flags that modify code generation, including <code>--coverage</code> or <code>-fsanitize=</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
